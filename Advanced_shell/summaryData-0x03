#!/bin/bash

# Configuration
DATA_DIR="pokemon_data"
REPORT_FILE="pokemon_report.csv"
TEMP_DATA="temp_pokemon_data.txt"

# Check if data directory exists
if [ ! -d "$DATA_DIR" ]; then
    echo "Error: $DATA_DIR directory not found. Run fetch_multiple_pokemon first."
    exit 1
fi

# Check if JSON files exist
json_files=("$DATA_DIR"/*.json)
if [ ! -e "${json_files[0]}" ]; then
    echo "Error: No JSON files found in $DATA_DIR directory."
    exit 1
fi

echo "Generating Pokemon report..."

# Create CSV header
echo "Name,Height (m),Weight (kg)" > "$REPORT_FILE"

# Initialize temp data file
> "$TEMP_DATA"

# Process each JSON file
for json_file in "$DATA_DIR"/*.json; do
    if [ -f "$json_file" ]; then
        # Extract data using jq
        name=$(jq -r '.name' "$json_file" 2>/dev/null)
        height=$(jq -r '.height' "$json_file" 2>/dev/null)
        weight=$(jq -r '.weight' "$json_file" 2>/dev/null)
        
        # Skip if any value is null or invalid
        if [ "$name" = "null" ] || [ "$height" = "null" ] || [ "$weight" = "null" ]; then
            continue
        fi
        
        # Use awk to convert units and format
        echo "$height $weight" | awk -v name="$name" '{
            height_m = $1 / 10
            weight_kg = $2 / 10
            cap_name = toupper(substr(name, 1, 1)) substr(name, 2)
            printf "%s,%.1f,%.1f\n", cap_name, height_m, weight_kg
        }' >> "$REPORT_FILE"
        
        # Store numeric data for statistics
        echo "$height $weight" | awk '{
            height_m = $1 / 10
            weight_kg = $2 / 10
            print height_m, weight_kg
        }' >> "$TEMP_DATA"
    fi
done

# Sort CSV by name (excluding header)
{
    head -n 1 "$REPORT_FILE"
    tail -n +2 "$REPORT_FILE" | sort
} > "${REPORT_FILE}.tmp" && mv "${REPORT_FILE}.tmp" "$REPORT_FILE"

echo "CSV Report generated at: $REPORT_FILE"
echo ""

# Display the CSV content
cat "$REPORT_FILE"
echo ""

# Calculate averages using awk
if [ -s "$TEMP_DATA" ]; then
    awk '{
        height_sum += $1
        weight_sum += $2
        count++
    }
    END {
        if (count > 0) {
            avg_height = height_sum / count
            avg_weight = weight_sum / count
            printf "Average Height: %.2f m\n", avg_height
            printf "Average Weight: %.2f kg\n", avg_weight
        }
    }' "$TEMP_DATA"
else
    echo "No data available for statistics calculation."
fi

# Clean up temporary files
rm -f "$TEMP_DATA" temp_stats.txt